<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="deployment" />
	<meta name="description" content="deployment" />
	<!-- 网页标签标题 -->
	<title>Deployment - Apache TubeMQ</title>
	<link rel="shortcut icon" href="/img/apache.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/en-us/index.html"><a href="//www.apache.org"><img class="logo apache" style="width:120px" src="/img/asf_logo.svg"/></a><div class="logo-split"></div><a href=""></a><img class="logo tube" style="width:72px" src="/img/Tube logo.svg"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">中</span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><div><ul class="ant-menu blackClass ant-menu-light ant-menu-root ant-menu-horizontal" role="menu"><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/index.html" target="_self">HOME</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/docs/quick_start.html" target="_self">DOCS</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/docs/download/download.html" target="_self">DOWNLOAD</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="/en-us/docs/development/how-to-contribute.html" target="_self">DEVELOPMENT</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-item" role="menuitem"><a href="https://github.com/apache/incubator-tubemq" target="_self">GITHUB</a></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span class="submenu-title-wrapper">Apache</span><i class="ant-menu-submenu-arrow"></i></div></li><li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute" role="menuitem"><div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul></div></div></div><div class="header-background"></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>Documentation</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>User Guide</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/quick_start.html" target="_self">Quick Start</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/producer_example.html" target="_self">Producer Example</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/consumer_example.html" target="_self">Consumer Example</a></li></ul></li><li class="menu-item menu-item-level-1"><span>Architecture &amp; Principle</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/architecture.html" target="_self">Architecture</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/client_rpc.html" target="_self">Client RPC</a></li></ul></li><li class="menu-item menu-item-level-1"><span>User Manual</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/deployment.html" target="_self">Deployment</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/configure_introduction.html" target="_self">Configure Introduction</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/console_introduction.html" target="_self">Console Introduction</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/error_code.html" target="_self">Error Code</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>API Introduction<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/http_access_api.html" target="_self">HTTP API</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/clients_java.html" target="_self">JAVA SDK API</a></li></ul></li></ul></li><li class="menu-item menu-item-level-1"><span><div class="menu-item menu-item-level-1" style="margin-left:-20px"><a href="/en-us/docs/contact.html" target="_self" style="padding-left:20px">Contact Us</a></div></span><ul></ul></li></ul></div><div class="doc-content markdown-body"><h1>Compile, Deploy and Examples of TubeMQ ：</h1>
<h2>Compile and Package Project：</h2>
<p>Enter the root directory of project and run:</p>
<pre><code>mvn clean package -Dmaven.test.skip
</code></pre>
<p>e.g. We put the TubeMQ project package at <code>E:/</code>, then run the above command. Compilation is complete when all subdirectories are compiled successfully.</p>
<p><img src="img/sysdeployment/sys_compile.png" alt=""></p>
<p>We can also run individual compilation in each subdirectory. Steps are the same as the whole project's compilation.</p>
<p><strong>Server Deployment</strong></p>
<p>As example above, entry directory <code>E:\GIT\TubeMQ\tubemq-server\target</code>, we can see several JARs. <code>tubemq-server-3.8.0-bin.tar.gz</code> is the complete server-side installation package， including execution scripts, configuration files, dependencies, and frontend source code. <code>tubemq-server-3.8.0.jar</code> is a server-side processing package included in <code>lib</code> of the complete project installer. Consider to daily changes and upgrades are most made to server side, we place this jar separately so that we just need to replace this jar during upgrade.</p>
<p><img src="img/sysdeployment/sys_package.png" alt=""></p>
<p>Here we have a complete package deployed onto server and we place it in <code>/data/tubemq</code></p>
<p><img src="img/sysdeployment/sys_package_list.png" alt=""></p>
<p><strong>Configuration System</strong></p>
<p>There are 3 roles in server package: Master, Broker and Tools. Master and Broker can be deployed on the same or different machine. It depends on the bussiness layouts. As example below, we have 3 machine to startup a complete production and consumption cluster with 2 Masters.</p>
<table>
<thead>
<tr>
<th>Machine</th>
<th>Role</th>
<th>TCP Port</th>
<th>TLS Port</th>
<th>WEB Port</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.224.148.145</td>
<td><strong>Master</strong></td>
<td>8099</td>
<td>8199</td>
<td>8080</td>
<td>Metadata stored at <code>/stage/metadata</code></td>
</tr>
<tr>
<td></td>
<td>Broker</td>
<td>8123</td>
<td>8124</td>
<td>8081</td>
<td>Message stored at<code>/stage/msgdata</code></td>
</tr>
<tr>
<td></td>
<td>ZK</td>
<td>2181</td>
<td></td>
<td></td>
<td>Offset stored at root directory<code>/tubemq</code></td>
</tr>
<tr>
<td>100.115.158.208</td>
<td><strong>Master</strong></td>
<td>8099</td>
<td>8199</td>
<td>8080</td>
<td>Metadata stored at <code>/stage/metadata</code></td>
</tr>
<tr>
<td></td>
<td>Broker</td>
<td>8123</td>
<td>8124</td>
<td>8081</td>
<td>Message stored at<code>/stage/msgdata</code></td>
</tr>
<tr>
<td>10.224.155.80</td>
<td>Producer</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>Consumer</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>Something should be noticed during deploying Master:</p>
<ol>
<li>Master cluster can be deployed in 1, 2 or 3 machines. 3 machines is suggested if HA is necessary so that reading/writing configuration and access to new production/consumption is still available when one of them is shutdown. In common situation, 2 machines provide readable configuration and proper state of production/consumption already registered when one is shutdown. The minimum is 1 and it provides proper state of production/consumption already registered when is shutdown.</li>
<li>For machines with Master Role, we should promise clock synchronization. At the same time, IP address of each Master machine should be set in <code>/etc/hosts</code> on each Master machine.</li>
</ol>
<p><img src="img/sysdeployment/sys_address_host.png" alt=""></p>
<p>Take <code>10.224.148.145</code> and <code>100.115.158.208</code> as examples, if we want to deploy both Master and Broker role on them, we need to configure in <code>/conf/master.ini</code>, <code>/resources/velocity.properties</code> and <code>/conf/broker.ini</code>. First set up the configuration of <code>10.224.148.145</code>,</p>
<p><img src="img/sysdeployment/sys_configure_1.png" alt=""></p>
<p>then it is <code>100.115.158.208</code>.</p>
<p><img src="img/sysdeployment/sys_configure_2.png" alt=""></p>
<p>Note that the upper right corner is configured with Master's web frontend configuration and configuration <code>file.resource.loader.path</code> in <code>/resources/velocity.properties</code> need to be modified according to the Master's installation path.</p>
<p><strong>Start up Master</strong>：</p>
<p>After configuration, entry directory <code>bin</code> of Master environment and start up master.</p>
<p><img src="img/sysdeployment/sys_master_start.png" alt=""></p>
<p>We First start up <code>10.224.148.145</code>, and then start up Master on <code>100.115.158.208</code>. The following messages indicate that the master and backup master have been successfully started up and the external service ports are reachable.</p>
<p><img src="img/sysdeployment/sys_master_startted.png" alt=""></p>
<p>Visiting Master's Administrator panel(<a href="http://100.115.158.208:8080/config/topic_list.htm">http://100.115.158.208:8080/config/topic_list.htm</a>), search operation working well indicates that master has been successfully started up.</p>
<p><img src="img/sysdeployment/sys_master_console.png" alt=""></p>
<p><strong>Start up Broker</strong>：</p>
<p>Starting up Broker is a little bit different to starting Master: Master is responsible for managing the entire TubeMQ cluster, including Broker node with Topic configuration on them, production and consumption managament. So we need to add metadata on Master before starting up Broker.</p>
<p><img src="img/sysdeployment/sys_broker_configure.png" alt=""></p>
<p>Confirm and create a draft record of Broker.</p>
<p><img src="img/sysdeployment/sys_broker_online.png" alt=""></p>
<p>We try to start up the Broker.</p>
<p><img src="img/sysdeployment/sys_broker_start.png" alt=""></p>
<p>But we got an error message.</p>
<p><img src="img/sysdeployment/sys_broker_start_error.png" alt=""></p>
<p>Because the broker record is currently in draft status and it is not available now. Let's go back to Master Administrator panel and publish.</p>
<p><img src="img/sysdeployment/sys_broker_online_2.png" alt=""></p>
<p>Every changing operation need to text in an Authorization Code when submited to Master. Authorization Code is defined by <code>confModAuthToken</code> in <code>master.ini</code>. If you have the Code of this cluster, we consider you as administrator and you have permission to operate the modification.</p>
<p><img src="img/sysdeployment/sys_broker_deploy.png" alt=""></p>
<p>Then we restart the Broker.</p>
<p><img src="img/sysdeployment/sys_broker_restart_1.png" alt=""></p>
<p><img src="img/sysdeployment/sys_broker_restart_2.png" alt=""></p>
<p>Check the Master Control Panel, broker has successfully registered.</p>
<p><img src="img/sysdeployment/sys_broker_finished.png" alt=""></p>
<p><strong>Topic Configuration and Activation</strong>：</p>
<p>Configuration of Topic is similar with Broker's, we should add metadata on Master before using them, otherwise it will report an Not Found Error during production/consumption. For example, if we try to consum a non-existent topic <code>test</code>,</p>
<pre><code>/usr/local/java/default/bin/java -Xmx512m -Dlog4j.configuration=file:/data/tubemq/tubemq-server-3.8.0/conf/tools.log4j.properties -Djava.net.preferIPv4Stack=true -cp /data/tubemq/tubemq-server-3.8.0/lib/\*:/data/tubemq/tubemq-server-3.8.0/conf/\*: com.tencent.tubemq.example.MessageProducerExample 100.115.158.208 10.224.148.145:8000,100.115.158.208:8000 test 10000000 
</code></pre>
<p>Demo returns error message.</p>
<p><img src="img/sysdeployment/sys_topic_error.png" alt=""></p>
<p>First we add a topic in topic list page in Master Control Panel.</p>
<p><img src="img/sysdeployment/sys_topic_create.png" alt=""></p>
<p><img src="img/sysdeployment/sys_topic_select.png" alt=""></p>
<p>Choose publish scope and confirm after submit topic detail. After adding a new topic, we need to overload the topic.</p>
<p><img src="img/sysdeployment/sys_topic_deploy.png" alt=""></p>
<p>Topic is available after overload. We can see some status of topic has changed after overload.</p>
<p><img src="img/sysdeployment/sys_topic_finished.png" alt=""></p>
<p><strong>Note</strong> When we are executing overload opertaion, we should make it in batches. Overload operations are controlled by state machines. It would become unwritable and un readale, read-only, readable and writable in order before published. Waiting for overloads on all brokers make topic temporary unreadable and unwritable, which result in production and consumption failure, especially production failure.</p>
<p><strong>Message Production and Consumption</strong>：</p>
<p>We pack Demo for test in package or <code>tubemq-client-3.8.0.jar</code> can be used for implementing your own production and consumption.
We run Producer Demo in below script and we can see data accepted on Broker.</p>
<pre><code>/usr/local/java/default/bin/java -Xmx512m -Dlog4j.configuration=file:/data/tubemq/tubemq-server-3.8.0/conf/tools.log4j.properties -Djava.net.preferIPv4Stack=true -cp /data/tubemq/tubemq-server-3.8.0/lib/\*:/data/tubemq/tubemq-server-3.8.0/conf/\*: com.tencent.tubemq.example.MessageProducerExample 100.115.158.208 10.224.148.145:8000,100.115.158.208:8000 test 10000000 
</code></pre>
<p><img src="img/sysdeployment/sys_node_status.png" alt=""></p>
<p>Then we run the Consumption Demo and we can see that consumption is also working properly.</p>
<pre><code> /usr/local/java/default/bin/java -Xmx512m -Dlog4j.configuration=file:/data/tubemq/tubemq-server-3.8.0/conf/tools.log4j.properties -Djava.net.preferIPv4Stack=true -cp /data/tubemq/tubemq-server-3.8.0/lib/\*:/data/tubemq/tubemq-server-3.8.0/conf/\*: com.tencent.tubemq.example.MessageConsumerExample 10.224.148.145 10.224.148.145:8000,100.115.158.208:8000 test testGroup 3 1 1 

</code></pre>
<p><img src="img/sysdeployment/sys_node_status_2.png" alt=""></p>
<p>As we can see, files relative to broker's production and consumption already exist.</p>
<p><img src="img/sysdeployment/sys_node_log.png" alt=""></p>
<p>Here, the compilation, deployment, system configuration, startup, production and consumption of TubeMQ has been completed!
If you need to get further, please refer to &quot;TubeMQ HTTP API&quot; and make your appropriate configuration settings.</p>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/incubator-logo.svg"/><div class="cols-container"><div class="col col-24"><p>Apache TubeMQ (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p></div></div><div class="copyright"><span>Copyright © 2019-2020 The Apache Software Foundation. Apache TubeMQ, TubeMQ, and its feather logo are trademarks of The Apache Software Foundation.</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script src="https://buttons.github.io/buttons.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>
