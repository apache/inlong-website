"use strict";(self.webpackChunkdocs_website=self.webpackChunkdocs_website||[]).push([[86352],{15680:(e,t,n)=>{n.d(t,{xA:()=>p,yg:()=>g});var r=n(96540);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=c(n),u=i,g=m["".concat(l,".").concat(u)]||m[u]||d[u]||o;return n?r.createElement(g,a(a({ref:t},p),{},{components:n})):r.createElement(g,a({ref:t},p))}));function g(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,a=new Array(o);a[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[m]="string"==typeof e?e:i,a[1]=s;for(var c=2;c<o;c++)a[c]=n[c];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},39535:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var r=n(58168),i=(n(96540),n(15680));const o={title:"Customize Flink Metrics in Sort",sidebar_position:4},a="Customize Flink Metrics in Sort-Connector",s={unversionedId:"development/extension_sort/custom_flink_metrics",id:"development/extension_sort/custom_flink_metrics",title:"Customize Flink Metrics in Sort",description:"Overview",source:"@site/docs/development/extension_sort/custom_flink_metrics.md",sourceDirName:"development/extension_sort",slug:"/development/extension_sort/custom_flink_metrics",permalink:"/docs/next/development/extension_sort/custom_flink_metrics",draft:!1,editUrl:"https://github.com/apache/inlong-website/edit/master/docs/development/extension_sort/custom_flink_metrics.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Customize Flink Metrics in Sort",sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Offline Sync Connector Extension",permalink:"/docs/next/development/extension_sort/offline_data_sync"},next:{title:"Transform UDF extension",permalink:"/docs/next/development/extension_transform/transform_udf"}},l={},c=[{value:"Overview",id:"overview",level:2},{value:"Steps to Insert Custom Flink Metrics",id:"steps-to-insert-custom-flink-metrics",level:2},{value:"1. Create the Metric Object",id:"1-create-the-metric-object",level:3},{value:"2. Implement the <code>registerMetricsForXXX</code> Method",id:"2-implement-the-registermetricsforxxx-method",level:3},{value:"3. Call the Registration Method in the Constructor",id:"3-call-the-registration-method-in-the-constructor",level:3},{value:"4. Write the Metric&#39;s Getter, Setter, and Operation Methods",id:"4-write-the-metrics-getter-setter-and-operation-methods",level:3},{value:"5. Add the New Metric Output in the <code>toString</code> Method",id:"5-add-the-new-metric-output-in-the-tostring-method",level:3},{value:"6. Insert the Custom Metric in appropriate places",id:"6-insert-the-custom-metric-in-appropriate-places",level:3},{value:"Testing and Verification",id:"testing-and-verification",level:2},{value:"Notes",id:"notes",level:2}],p={toc:c},m="wrapper";function d(e){let{components:t,...n}=e;return(0,i.yg)(m,(0,r.A)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.yg)("h1",{id:"customize-flink-metrics-in-sort-connector"},"Customize Flink Metrics in Sort-Connector"),(0,i.yg)("h2",{id:"overview"},"Overview"),(0,i.yg)("p",null,"The InLong Sort framework allows users to define and insert custom Flink metrics within different connectors to monitor the data processing pipeline closely. These custom metrics are generally used to track key performance indicators such as serialization/deserialization success/failure counts, latency, snapshot states, transaction completion statuses, etc. These metrics are recorded and reported through ",(0,i.yg)("inlineCode",{parentName:"p"},"SourceExactlyMetric")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"SinkExactlyMetric")," objects at the appropriate logic nodes."),(0,i.yg)("h2",{id:"steps-to-insert-custom-flink-metrics"},"Steps to Insert Custom Flink Metrics"),(0,i.yg)("p",null,"To create and insert a custom Flink metric within a new connector, you typically need to follow these steps. Using the example of tracking deserialization error count (",(0,i.yg)("inlineCode",{parentName:"p"},"numDeserializeError"),") in the ",(0,i.yg)("inlineCode",{parentName:"p"},"inlong-sort/sort-flink/sort-flink-v1.15/sort-connectors/postgres-cdc"),", the following steps outline how to insert a custom metric within the InLong Sort framework."),(0,i.yg)("h3",{id:"1-create-the-metric-object"},"1. Create the Metric Object"),(0,i.yg)("p",null,"First, add a new Flink metric object in the ",(0,i.yg)("inlineCode",{parentName:"p"},"SourceExactlyMetric")," or ",(0,i.yg)("inlineCode",{parentName:"p"},"SinkExactlyMetric")," class. Metric objects can typically be of types like ",(0,i.yg)("inlineCode",{parentName:"p"},"Counter"),", ",(0,i.yg)("inlineCode",{parentName:"p"},"Gauge"),", or ",(0,i.yg)("inlineCode",{parentName:"p"},"Meter"),". In this example, a ",(0,i.yg)("inlineCode",{parentName:"p"},"Counter")," is created to track deserialization errors and is added as a class member:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"private Counter numDeserializeError;\n")),(0,i.yg)("h3",{id:"2-implement-the-registermetricsforxxx-method"},"2. Implement the ",(0,i.yg)("inlineCode",{parentName:"h3"},"registerMetricsForXXX")," Method"),(0,i.yg)("p",null,"To initialize and register this metric object, write a ",(0,i.yg)("inlineCode",{parentName:"p"},"registerMetricsForNumDeserializeError")," method. Within this method, the ",(0,i.yg)("inlineCode",{parentName:"p"},"Counter")," object is registered with Flink's metric system using ",(0,i.yg)("inlineCode",{parentName:"p"},"registerCounter"),", allowing Flink to track the metric."),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},'public void registerMetricsForNumDeserializeError(Counter counter) {\n    numDeserializeError = registerCounter("numDeserializeError", counter);\n}\n')),(0,i.yg)("p",null,"In this method, the custom ",(0,i.yg)("inlineCode",{parentName:"p"},"Counter")," object is linked to Flink's metric system using ",(0,i.yg)("inlineCode",{parentName:"p"},"registerCounter"),", ensuring that the metric is properly recorded during data processing."),(0,i.yg)("h3",{id:"3-call-the-registration-method-in-the-constructor"},"3. Call the Registration Method in the Constructor"),(0,i.yg)("p",null,"Within the class constructor, call the registration method with the ",(0,i.yg)("inlineCode",{parentName:"p"},"MetricOption")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"MetricGroup")," parameters. This ensures the metric object is properly initialized and registered upon instantiation:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"public SourceExactlyMetric(MetricOption option, MetricGroup metricGroup) {\n    this.metricGroup = metricGroup;\n    this.labels = option.getLabels();\n    registerMetricsForNumDeserializeError(new ThreadSafeCounter());\n}\n")),(0,i.yg)("p",null,"By calling the ",(0,i.yg)("inlineCode",{parentName:"p"},"registerMetricsForNumDeserializeError")," method in the constructor, the ",(0,i.yg)("inlineCode",{parentName:"p"},"numDeserializeError")," counter is initialized and ready to record deserialization errors upon each instantiation."),(0,i.yg)("h3",{id:"4-write-the-metrics-getter-setter-and-operation-methods"},"4. Write the Metric's Getter, Setter, and Operation Methods"),(0,i.yg)("p",null,"To manipulate the ",(0,i.yg)("inlineCode",{parentName:"p"},"numDeserializeError")," counter externally, implement the necessary getter and operation methods. In this case, an ",(0,i.yg)("inlineCode",{parentName:"p"},"incNumDeserializeError")," method increments the counter whenever a deserialization error occurs:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"public void incNumDeserializeError() {\n    if (numDeserializeError != null) {\n        numDeserializeError.inc();\n    }\n}\n")),(0,i.yg)("p",null,"This method ensures that ",(0,i.yg)("inlineCode",{parentName:"p"},"incNumDeserializeError")," is called to increment the error count whenever a deserialization error is detected."),(0,i.yg)("h3",{id:"5-add-the-new-metric-output-in-the-tostring-method"},"5. Add the New Metric Output in the ",(0,i.yg)("inlineCode",{parentName:"h3"},"toString")," Method"),(0,i.yg)("p",null,"To facilitate debugging, monitoring and ensure the completeness of code, include the custom metric output in the ",(0,i.yg)("inlineCode",{parentName:"p"},"toString")," method:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},'@Override\npublic String toString() {\n    return "SourceMetricData{" \n        + ", numDeserializeError=" + numDeserializeError.getCount()\n        + "}";\n}\n')),(0,i.yg)("h3",{id:"6-insert-the-custom-metric-in-appropriate-places"},"6. Insert the Custom Metric in appropriate places"),(0,i.yg)("p",null,"After registering and initializing the metric, invoke it at the appropriate logic node. In this example, call ",(0,i.yg)("inlineCode",{parentName:"p"},"incNumDeserializeError")," in the deserialization method to track each deserialization error. The following code shows how to implement this:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-java"},"@Override\npublic void deserialize(SourceRecord record, Collector<RowData> out) throws Exception {\n    try {\n        // Execute deserialization logic\n    } catch (Exception e) {\n        // Increment error count on deserialization failure\n        // Ensure sourceExactlyMetric is not null\n        if(sourceExactlyMetric != null) {\n            sourceExactlyMetric.incNumDeserializeError();\n        }\n        throw e;\n    }\n}\n")),(0,i.yg)("p",null,"This method ensures that each deserialization error triggers ",(0,i.yg)("inlineCode",{parentName:"p"},"incNumDeserializeError"),", accurately reflecting error frequency."),(0,i.yg)("h2",{id:"testing-and-verification"},"Testing and Verification"),(0,i.yg)("p",null,"Using ",(0,i.yg)("inlineCode",{parentName:"p"},"sort-end-to-end-tests")," located in the ",(0,i.yg)("inlineCode",{parentName:"p"},"inlong-sort/sort-end-to-end-tests/")," directory:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Set Metric Labels in SQL"),": Add ",(0,i.yg)("inlineCode",{parentName:"p"},"inlong.metric.labels")," in the test SQL file to ensure Flink recognizes the metric labels. For example, in ",(0,i.yg)("inlineCode",{parentName:"p"},"sort-end-to-end-tests/sort-end-to-end-tests-v1.15/src/test/resources/flinkSql/postgres_test.sql"),":"),(0,i.yg)("pre",{parentName:"li"},(0,i.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE test_input1 (\n    `id` INT primary key,\n    name STRING,\n    description STRING\n) WITH (\n    'connector' = 'postgres-cdc-inlong',\n    'hostname' = 'postgres',\n    'port' = '5432',\n    'username' = 'flinkuser',\n    'password' = 'flinkpw',\n    'database-name' = 'test',\n    'table-name' = 'test_input1',\n    'schema-name' = 'public',\n    'decoding.plugin.name' = 'pgoutput',\n    'slot.name' = 'inlong_slot',\n    'debezium.slot.name' = 'inlong_slot',\n    -- Added portion\n    'inlong.metric.labels' = 'groupId=pggroup&streamId=pgStream&nodeId=pgNode'\n);\n\n-- Keep Flink SQL for sink unchanged\n"))),(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Configure Log Output for Metric Viewing"),": Enable metric log output in the test environment configuration to view results on the console:"),(0,i.yg)("pre",{parentName:"li"},(0,i.yg)("code",{parentName:"pre",className:"language-properties"},"metrics.reporter.slf4j.class: org.apache.flink.metrics.slf4j.Slf4jReporter\nmetrics.reporter.slf4j.interval: 5 SECONDS\n"))),(0,i.yg)("li",{parentName:"ol"},(0,i.yg)("p",{parentName:"li"},(0,i.yg)("strong",{parentName:"p"},"Run the end-to-end Test and Verify Output"),": Run the specific end-to-end test under path ",(0,i.yg)("inlineCode",{parentName:"p"},"inlong-sort/sort-end-to-end-tests/sort-end-to-end-tests-v1.15")," and check whether ",(0,i.yg)("inlineCode",{parentName:"p"},"numDeserializeError")," is the expected value:"),(0,i.yg)("pre",{parentName:"li"},(0,i.yg)("code",{parentName:"pre",className:"language-bash"},"mvn test -Dtest=Postgres2StarRocksTest\n")))),(0,i.yg)("p",null,"Note: You may want to insert test code or construct specific data to trigger ",(0,i.yg)("inlineCode",{parentName:"p"},"incDeserializeError()")," and ensure your metrics are functioning as expected."),(0,i.yg)("h2",{id:"notes"},"Notes"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"Pass ",(0,i.yg)("inlineCode",{parentName:"strong"},"MetricGroup")," When Creating Metrics"),": Ensure that when creating ",(0,i.yg)("inlineCode",{parentName:"li"},"SourceExactlyMetric")," or ",(0,i.yg)("inlineCode",{parentName:"li"},"SinkExactlyMetric"),", you pass a ",(0,i.yg)("inlineCode",{parentName:"li"},"MetricGroup")," obtained via ",(0,i.yg)("inlineCode",{parentName:"li"},"runtimeContext")," to avoid registration failures."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"Check for Non-Null ",(0,i.yg)("inlineCode",{parentName:"strong"},"MetricOption")),": Validate that ",(0,i.yg)("inlineCode",{parentName:"li"},"MetricOption")," is non-null before creating metric objects to avoid null pointer exceptions due to missing ",(0,i.yg)("inlineCode",{parentName:"li"},"inlong.metric.labels"),"."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"Handle Null Pointers"),": Check for null ",(0,i.yg)("inlineCode",{parentName:"li"},"SourceExactlyMetric")," or ",(0,i.yg)("inlineCode",{parentName:"li"},"SinkExactlyMetric")," objects when operating on custom metrics like ",(0,i.yg)("inlineCode",{parentName:"li"},"incNumDeserializeSuccess()")," to avoid null pointer exceptions if ",(0,i.yg)("inlineCode",{parentName:"li"},"'inlong.metric.labels'")," isn\u2019t specified."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"End-to-end Test Coverage"),": If a new connector metric isn\u2019t covered by an end-to-end test, create a test to verify metric reporting functionality.")),(0,i.yg)("p",null,"This approach allows the insertion of custom Flink metrics in the Postgres connector, verified by testing, to enhance observability."))}d.isMDXComponent=!0}}]);