<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-2.0.0 plugin-docs plugin-id-default docs-doc-id-development/binary_protocol/tubemq_binary">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">TubeMQ binary protocol | Apache InLong</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://inlong.apache.org/docs/2.0.0/development/binary_protocol/tubemq_binary"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="2.0.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-2.0.0"><meta data-rh="true" name="docsearch:version" content="2.0.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-2.0.0"><meta data-rh="true" property="og:title" content="TubeMQ binary protocol | Apache InLong"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/img/logo.svg"><link data-rh="true" rel="canonical" href="https://inlong.apache.org/docs/2.0.0/development/binary_protocol/tubemq_binary"><link data-rh="true" rel="alternate" href="https://inlong.apache.org/docs/2.0.0/development/binary_protocol/tubemq_binary" hreflang="en"><link data-rh="true" rel="alternate" href="https://inlong.apache.org/zh-CN/docs/2.0.0/development/binary_protocol/tubemq_binary" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://inlong.apache.org/docs/2.0.0/development/binary_protocol/tubemq_binary" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://YUW9QEL53E-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache InLong RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache InLong Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Apache InLong" href="/opensearch.xml">



<script src="https://www.apachecon.com/event-images/snippet.js" async></script><link rel="stylesheet" href="/assets/css/styles.7d3d0a53.css">
<link rel="preload" href="/assets/js/runtime~main.1307b338.js" as="script">
<link rel="preload" href="/assets/js/main.919e10fa.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Apache" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Apache" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Apache InLong</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/introduction">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/introduction">Next</a></li><li><a class="dropdown__link" href="/docs/introduction">2.1.0</a></li><li><a class="dropdown__link" href="/docs/2.0.0/introduction">2.0.0</a></li><li><a class="dropdown__link" href="/versions/">All versions</a></li></ul></div><a class="navbar__item navbar__link" href="/downloads">Download</a><a class="navbar__item navbar__link" href="/community/how-to-contribute">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/team">Team</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Apache Software Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/2.0.0/development/binary_protocol/tubemq_binary" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-CN/docs/2.0.0/development/binary_protocol/tubemq_binary" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">简体中文</a></li></ul></div><a href="https://github.com/apache/inlong" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/2.0.0/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.0.0/design_and_concept/basic_concept">Design and Concept</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.0.0/quick_start/data_ingestion/file_pulsar_clickhouse_example">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.0.0/deployment/standalone">Deployment</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.0.0/modules/agent/overview">Components</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.0.0/data_node/extract_node/overview">Data Nodes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.0.0/sdk/dataproxy-sdk/cpp">SDK</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.0.0/user_guide/dashboard_usage">User Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/2.0.0/development/how_to_build">Development</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.0.0/development/how_to_build">How to Build</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/2.0.0/development/binary_protocol/inlong_msg">Binary Protocol</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.0.0/development/binary_protocol/inlong_msg">InLongMsg format definition and usage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.0.0/development/binary_protocol/agent">Agent binary protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.0.0/development/binary_protocol/dataproxy_binary">DataProxy binary protocol and usage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2.0.0/development/binary_protocol/tubemq_binary">TubeMQ binary protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.0.0/development/binary_protocol/audit_msg">Audit data format definition and usage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/2.0.0/development/extension_agent/agent">Agent Plugins Extension</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/2.0.0/development/extension_dataproxy/how_to_write_plugin_dataproxy">DataProxy Plugins Extension</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/2.0.0/development/extension_manager/inlong_manager_shiro_plugin">Manager Plugins Extension</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/2.0.0/development/extension_sort/extension_connector">Sort Plugins Extension</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/2.0.0/development/extension_transform/transform_udf">Transform Plugins Extension</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/2.0.0/development/extension_dashboard/how_to_write_plugin_dashboard">Dashboard Plugins Extension</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2.0.0/development/api">REST API</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/2.0.0/administration/user_management">Administration</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/2.0.0/contact">Contact Us</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Apache InLong<!-- --> <b>2.0.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/development/binary_protocol/tubemq_binary">latest version</a></b> (<!-- -->2.1.0<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Development</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Binary Protocol</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">TubeMQ binary protocol</span><meta itemprop="position" content="3"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 2.0.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>TubeMQ binary protocol</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2><p>The various nodes (Client, Master, Broker) of the InLong TubeMQ module interact with each other in the form of TCP long connections, and use a custom binary encoding protocol to construct interactive request and response messages. This article mainly introduces the definition of the binary protocol and gives an example of how to complete the entire process of TubeMQ production and consumption interaction through this protocol.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tubemq-message-format">TubeMQ message format<a href="#tubemq-message-format" class="hash-link" aria-label="Direct link to TubeMQ message format" title="Direct link to TubeMQ message format">​</a></h2><p>The following figure is a schematic diagram of the TubeMQ message format definition:</p><p><img loading="lazy" alt="TubeMQ message frame" src="/assets/images/tubemq_frame-ee9e2f92e2ccf3edd68a79dc4693da0b.png" width="1081" height="699" class="img_ev3q"></p><p>As shown from the figure above, each interactive message consists of three fixed parts:</p><ul><li><p>MsgToken: this field is used to identify the legitimacy of the TubeMQ message. Each TubeMQ message will carry the specified <code>RPC_PROTOCOL_BEGIN_TOKEN</code> parameter value. When the client receives a message that does not start with this field, it means that the message is not a legitimate message sent by TubeMQ. The connection can be closed according to the policy, prompting an error exit or reconnection;</p></li><li><p>SerialNo: the message sequence number is generated by the requester and returned by the recipient of the request in the response message as is, so that the recipient of the response can associate the request corresponding to the response message lock;</p></li><li><p>Message content part: this part is encoded by Protobuf and consists of several parts:</p><ul><li><p>ListSize: 4 bytes, indicating the total number of data blocks after the data encoded by Protobuf is cut into a certain length. This field is not 0 under the current protocol definition;</p></li><li><p><code>[&lt;Length&gt;&lt;Data&gt;]</code>: data block, composed of 2 fields, indicating the length of the data block sent and the data content, among which:</p><ul><li><p>Length: identifies the length of the data block</p></li><li><p>Data: identifies the binary data content of the data block</p></li></ul></li></ul></li></ul><p>Why is the Protobuf (hereinafter referred to as PB) encoded data content defined in the form of <code>ListSize [&lt;Length&gt;&lt;Data&gt;]</code>?</p><p>The main reason is that in the initial implementation of TubeMQ, the serialized PB data is stored in ByteBuffer objects. The maximum block length of a single ByteBuffer in Java is 8196 bytes. PB message content exceeding the length of a single block is stored in multiple ByteBuffers; and when the data is serialized to the TCP message, the total length is not counted, and the ByteBuffer list serialized in PB is directly written into the message.
<strong>When implementing in multiple languages, this needs special attention:</strong> the PB data content needs to be serialized into a block array (there is corresponding support in the PB codec).</p><p>The PB codec file of the message content is stored in the <code>org.apache.inlong.tubemq.corerpc</code> module. For detailed format definitions, refer to the relevant files.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pb-format-encoding">PB format encoding<a href="#pb-format-encoding" class="hash-link" aria-label="Direct link to PB format encoding" title="Direct link to PB format encoding">​</a></h3><p>The PB protocol is divided into three parts:</p><ul><li><p>RPC framework definition: <code>RPC.proto</code></p></li><li><p>Master-related message encoding: <code>MasterService.proto</code></p></li><li><p>Broker-related message encoding: <code>BrokerService.proto</code></p></li></ul><p>These protocol definition files are directly compiled through PB to obtain the corresponding implementation class. Taking RPC.proto as an example, RPC.proto defines 6 structures, which are divided into 2 types:</p><ul><li><p>Request message</p></li><li><p>Response message, including normal response return and response return in case of exception</p></li></ul><p>The request message encoding and response message decoding can be implemented by referring to the <code>NettyClient.java</code> class. There is some room for improvement in the definition of this part, see <a href="https://issues.apache.org/jira/browse/TUBEMQ-109" target="_blank" rel="noopener noreferrer">TUBEMQ-109</a> for details. However, due to compatibility considerations, it will be gradually replaced. According to the current proto version, interaction is not a problem at least before version 1.0.0, but the new protocol will be considered for 1.0.0. The protocol implementation module requires each SDK to reserve room for improvement.</p><p>Taking the request message filling as an example, the RpcConnHeader and other related structures are as follows:</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">message RpcConnHeader {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int32 flag = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int64 traceId = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int64 spanId = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int64 parentId = 4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message RequestHeader {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int32 serviceType = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int32 protocolVer = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message RequestBody {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int32 method = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int64 timeout = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional bytes request = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Among them:</p><ul><li><p><code>RpcConnHeader</code>&#x27;s <code>flag</code> marks whether the message is requested, and the following three fields mark the relevant content of message tracking, which is not used at present;</p></li><li><p><code>RequestHeader</code> contains information about service type and protocol version;</p></li><li><p><code>RequestBody</code> contains request method, timeout, and request content, among which <code>timeout</code> is the maximum allowed waiting time from when a request is received by the server to when it is actually processed. If it exceeds, it will be discarded. The current default is 10 seconds.</p></li></ul><p>The specific implementation of request filling is shown in the following part:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">RequestWrapper requestWrapper =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                new RequestWrapper(PbEnDecoder.getServiceIdByServiceName(targetInterface),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        RpcProtocol.RPC_PROTOCOL_VERSION,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        RpcConstants.RPC_FLAG_MSG_TYPE_REQUEST,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                        requestTimeout); // request timeout</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At this point, the introduction to the protocol format definition of TubeMQ is complete. Next, we will complete data production and consumption with messages composed of these protocol formats.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="client-request-response-interaction">Client request response interaction<a href="#client-request-response-interaction" class="hash-link" aria-label="Direct link to Client request response interaction" title="Direct link to Client request response interaction">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="producer-production-interaction-diagram">Producer production interaction diagram<a href="#producer-production-interaction-diagram" class="hash-link" aria-label="Direct link to Producer production interaction diagram" title="Direct link to Producer production interaction diagram">​</a></h3><p>The Producer uses a total of 4 pairs of instructions: registering with the Master node, maintaining heartbeats, and exiting registration operations; interacting with the Broker node to report messages:</p><p><img loading="lazy" alt="Producer RPC interaction" src="/assets/images/tubemq_rpc_producer-8fbd10d3c691b6a79eb67f5ec5c0b799.png" width="975" height="792" class="img_ev3q"></p><p>From here we can see that the Producer obtains metadata information such as the partition list corresponding to the specified Topic from the Master. After obtaining this information, it selects the partition according to the client&#x27;s rules and sends the message to the corresponding Broker.</p><p>Producer needs to pay attention to <strong>multi-language implementation:</strong></p><ul><li><p>The Master has active and standby nodes, and only the active node can provide services. When the Producer connects to the standby node, it will receive a <code>StandbyException</code> exception response. At this time, the client needs to select other Master nodes for registration, and finally select the active Master node for registration;</p></li><li><p>When the Master connection fails during the production process, such as timeout, passive disconnection of the link, etc., the Producer must initiate a re-registration request to the Master;</p></li><li><p>After receiving the metadata information of the Topic from the Master, the Producer must pre-connect to the Broker in advance to avoid a sudden increase in connection requests during data production that affects the message reporting performance;</p></li><li><p>The connection between the Producer and the Broker must be detected for anomalies: Broker failure nodes must be detected in long-term running scenarios, and links that have not sent messages for a long time must be recycled to improve the stability of the data reporting service.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-consumption-interaction-diagram">Consumer consumption interaction diagram<a href="#consumer-consumption-interaction-diagram" class="hash-link" aria-label="Direct link to Consumer consumption interaction diagram" title="Direct link to Consumer consumption interaction diagram">​</a></h3><p>Consumer uses a total of 8 pairs of instructions: registering with the Master, heartbeat, and deregistering; registering with the Broker, deregistering, heartbeat, pulling messages, and confirming messages; the registration and deregistration with the Broker use the same command name with different status codes to identify and distinguish different operations:</p><p><img loading="lazy" alt="Consumer RPC interaction" src="/assets/images/tubemq_rpc_consumer-52cb707ba1d01b002dfaaf611138b231.png" width="857" height="797" class="img_ev3q"></p><p>From the example in the figure above, we can see that:</p><ul><li><p>When the Consumer registers with the main Master node, the Master does not return metadata information to the Consumer, but returns it in the subsequent heartbeat link. The reason is that the Consumer in the example uses the server-side load balancing mode, and needs to wait for the server to distribute the consumption partition information before obtaining the corresponding consumption partition;</p></li><li><p>There are registration and un-registration operations from Consumer to Broker. The reason is that the partition is exclusive consumption during consumption, that is, the same partition can only be consumed by one consumer in the same group at the same time. The client obtains the consumption rights of the partition through the registration operation;</p></li><li><p>Consumer message pulling and consumption confirmation need to appear in pairs. Through the secondary confirmation of data consumption, the problem of repeated consumption can be minimized as much as possible, and the problem of data being missed in abnormal situations can be solved.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-rpc-interaction-process-between-the-client-and-the-server">The RPC interaction process between the client and the server<a href="#the-rpc-interaction-process-between-the-client-and-the-server" class="hash-link" aria-label="Direct link to The RPC interaction process between the client and the server" title="Direct link to The RPC interaction process between the client and the server">​</a></h3><p>As shown below:</p><p><img loading="lazy" alt="TubeMQ RPC Implementation" src="/assets/images/tubemq_rpc-b4d088efd4c56dc98848e886730b4dd7.png" width="903" height="715" class="img_ev3q"></p><ul><li><p>When the client interacts with the TubeMQ server, it must maintain local storage of the sent request message until the RPC times out or a response message is received;</p></li><li><p>The client associates the SerialNo value carried in the response message with the previously cached sent request record;</p></li><li><p>After receiving the Broker and Topic metadata information from the Master, the client must save it locally and update it with the latest metadata, and report the cached metadata to the Master regularly;</p></li><li><p>The client must maintain the heartbeat of the Master or Broker. If the Master reports a registration timeout error, it must re-register;</p></li><li><p>The client must establish a connection based on the Broker, and the business is allowed to choose to establish a connection by object or by process between different objects in the same process.</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="producer-registers-with-the-master">Producer registers with the Master<a href="#producer-registers-with-the-master" class="hash-link" aria-label="Direct link to Producer registers with the Master" title="Direct link to Producer registers with the Master">​</a></h4><hr><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">message RegisterRequestP2M {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string clientId = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    repeated string topicList = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int64 brokerCheckSum = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string hostName = 4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional MasterCertificateInfo authInfo = 5;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional string jdkVersion = 6;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional ApprovedClientConfig appdConfig = 7;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message RegisterResponseM2P {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required bool success = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int32 errCode = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string errMsg = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int64 brokerCheckSum = 4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    repeated string brokerInfos = 5;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional MasterAuthorizedInfo authorizedInfo = 6;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional ApprovedClientConfig appdConfig = 7;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>clientId：Identifies the Producer object. The ID value is constructed when the Producer is started and is valid during the Producer life cycle. The current construction rules of the Java version of the SDK are:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ClientId = consumerGroup + &quot;_&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          + AddressUtils.getLocalAddress() + &quot;_&quot; // local ip (IPV4)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          + pid + &quot;_&quot; // processId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          + timestamp + &quot;_&quot; // timestamp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          + counter + &quot;_&quot; // increament counter</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          + consumerType + &quot;_&quot; // type of consumer，including Pull and Push </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          + clientVersion; // version for client</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It is recommended that other languages add the above mark to facilitate troubleshooting;</p></li><li><p>topicList: Identifies the topic list published by the user. The Producer will provide the initial topic list of the data to be published during initialization. During operation, the business is also allowed to delay adding new topics and reducing published topics through the Publish function;</p></li><li><p>brokerCheckSum: The check value of the Broker metadata information saved locally by the client. The Producer does not have this data locally during initial startup, so the value is -1; the SDK needs to carry the last brokerCheckSum value in each request, and the Master determines whether the client&#x27;s metadata needs to be updated by comparing this value;</p></li><li><p>hostname: The IPV4 address value of the machine where the Producer is located;</p></li><li><p>success: Whether the operation is successful, success is true, and failure is false;</p></li><li><p>errCode: Error code, combined with errMsg information to determine the specific cause of the error;</p></li><li><p>errMsg: Error message, if the request response fails, the SDK needs to print out the specific error message</p></li><li><p>authInfo: authentication and authorization information. If the user configuration has filled in the &quot;Start authentication process&quot;, fill it in; if authentication is required, report it according to the signature of the username and password. If it is running, such as during heartbeat, if the Master forces authentication, report it according to the signature of the username and password. If not, authenticate it according to the authorization token provided by the Master during the previous interaction; the authorization token is also used to carry the message production to the Broker during production.</p></li><li><p>brokerInfos: Broker metadata information. This field mainly contains the Broker information list of the entire cluster fed back by the Master to the Producer; its format is as follows:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">public BrokerInfo(String strBrokerInfo, int brokerPort) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String[] strBrokers =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                strBrokerInfo.split(TokenConstants.ATTR_SEP);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.brokerId = Integer.parseInt(strBrokers[0]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.host = strBrokers[1];</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.port = brokerPort;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (!TStringUtils.isBlank(strBrokers[2])) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            this.port = Integer.parseInt(strBrokers[2]);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        this.buildStrInfo();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>authorizedInfo：Master provides authorization information in the following format:</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">message MasterAuthorizedInfo {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int64 visitAuthorizedToken = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional string authAuthorizedToken = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>visitAuthorizedToken: Access authorization token, to prevent the client from bypassing the Master to access the Broker node. The SDK needs to save this information locally and carry this information when accessing the Broker in the future. If this field changes in the subsequent heartbeat, the locally cached data of this field needs to be updated;</p></li><li><p>authAuthorizedToken: Authorization token that has passed authentication. If there is data in this field, the SDK needs to save it and carry this field information when accessing the Master and Broker in the future. If this field changes in the subsequent heartbeat, the locally cached data of this field needs to be updated.</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="producer-to-master-heartbeat">Producer to Master Heartbeat<a href="#producer-to-master-heartbeat" class="hash-link" aria-label="Direct link to Producer to Master Heartbeat" title="Direct link to Producer to Master Heartbeat">​</a></h4><hr><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">message HeartRequestP2M {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string clientId = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int64 brokerCheckSum = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string hostName = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    repeated string topicList = 4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional MasterCertificateInfo authInfo = 5;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional ApprovedClientConfig appdConfig = 6;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message HeartResponseM2P {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required bool success = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int32 errCode = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string errMsg = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int64 brokerCheckSum = 4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /* brokerId:host:port-topic:partitionNum */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    repeated string topicInfos = 5;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    repeated string brokerInfos = 6;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional bool requireAuth = 7;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional MasterAuthorizedInfo authorizedInfo = 8;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional ApprovedClientConfig appdConfig = 9;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>topicInfos: Topic metadata information published by the SDK, including partition information and the Broker node where it is located. The specific decoding method is as follows:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">public static Tuple2&lt;Map&lt;String, Integer&gt;, List&lt;TopicInfo&gt;&gt; convertTopicInfo(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            Map&lt;Integer, BrokerInfo&gt; brokerInfoMap, List&lt;String&gt; strTopicInfos) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        List&lt;TopicInfo&gt; topicList = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        Map&lt;String, Integer&gt; topicMaxSizeInBMap = new ConcurrentHashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (strTopicInfos == null || strTopicInfos.isEmpty()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return new Tuple2&lt;&gt;(topicMaxSizeInBMap, topicList);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String[] strInfo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String[] strTopicInfoSet;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        String[] strTopicInfo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        BrokerInfo brokerInfo;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        for (String info : strTopicInfos) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (info == null || info.isEmpty()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            info = info.trim();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            strInfo = info.split(TokenConstants.SEGMENT_SEP, -1);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            strTopicInfoSet = strInfo[1].split(TokenConstants.ARRAY_SEP);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            for (String s : strTopicInfoSet) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                strTopicInfo = s.split(TokenConstants.ATTR_SEP);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                brokerInfo = brokerInfoMap.get(Integer.parseInt(strTopicInfo[0]));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                if (brokerInfo != null) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                    topicList.add(new TopicInfo(brokerInfo,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                            strInfo[0], Integer.parseInt(strTopicInfo[1]),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                            Integer.parseInt(strTopicInfo[2]), true, true));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            if (strInfo.length == 2 || TStringUtils.isEmpty(strInfo[2])) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                topicMaxSizeInBMap.put(strInfo[0], Integer.parseInt(strInfo[2]));</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                //</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return new Tuple2&lt;&gt;(topicMaxSizeInBMap, topicList);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>requireAuth: indicates that the previous authorized access code (authAuthorizedToken) of the Master has expired, requiring the SDK to carry the signature information of the username and password for authentication in the next request;</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="producer-to-master-close-and-exit">Producer to Master Close and Exit<a href="#producer-to-master-close-and-exit" class="hash-link" aria-label="Direct link to Producer to Master Close and Exit" title="Direct link to Producer to Master Close and Exit">​</a></h4><hr><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">message CloseRequestP2M{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string clientId = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional MasterCertificateInfo authInfo = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message CloseResponseM2P{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required bool success = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int32 errCode = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string errMsg = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Noted that if authentication is turned on, authentication will be done when it is turned off to avoid external interference.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="producer-sends-messages-to-broker">Producer sends messages to Broker<a href="#producer-sends-messages-to-broker" class="hash-link" aria-label="Direct link to Producer sends messages to Broker" title="Direct link to Producer sends messages to Broker">​</a></h4><hr><p>The content of this section is mainly related to the definition of Message:</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">message SendMessageRequestP2B {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string clientId = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string topicName = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int32 partitionId = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required bytes data = 4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int32 flag = 5;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int32 checkSum = 6;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int32 sentAddr = 7;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional string msgType = 8;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional string msgTime = 9;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional AuthorizedInfo authInfo = 10;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">message SendMessageResponseB2P {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required bool success = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required int32 errCode = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    required string errMsg = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional bool requireAuth = 4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int64 messageId = 5;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int64 appendTime = 6;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int64 appendOffset = 7;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>data: Binary byte stream information of Message, implemented as follows:</p><div class="language-Java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">private byte[] encodePayload(final Message message) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        final byte[] payload = message.getData();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        final String attribute = message.getAttribute();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        if (TStringUtils.isBlank(attribute)) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            return payload;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        byte[] attrData = StringUtils.getBytesUtf8(attribute);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        final ByteBuffer buffer =</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                ByteBuffer.allocate(4 + attrData.length + payload.length);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        buffer.putInt(attrData.length);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        buffer.put(attrData);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        buffer.put(payload);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        return buffer.array();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>sentAddr: IPv4 of the local machine where the SDK is located. Here, the IP address is converted into a 32-bit digital ID;</p></li><li><p>msgType: The stream value to which the message belongs, used for filtering consumption;</p></li><li><p>msgTime The time when the SDK sends a message. Its value comes from the value filled in by putSystemHeader when constructing the Message;</p></li><li><p>requireAuth: Whether authentication identification is required for data production to the Broker. Considering performance issues, it is not effective at present. The authAuthorizedToken value filled in the sent message is based on the value provided by the Master side and changes with the Master side.</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="partition-loadbalance">Partition Loadbalance<a href="#partition-loadbalance" class="hash-link" aria-label="Direct link to Partition Loadbalance" title="Direct link to Partition Loadbalance">​</a></h4><hr><p>The InLong TubeMQ module currently supports two balancing modes: server-side load balancing and client-side balancing. The business can choose different balancing methods according to needs.</p><p>The server balancing process is managed and maintained by the server, and the requirements for the Consumer consumption side are relatively low. The load balancing process is as follows:</p><ol><li><p>After the Master process is started, the load balancing thread balancerChore is started. BalancerChore periodically checks the currently registered consumer groups and performs load balancing. In simple terms, the process is to evenly distribute the partitions subscribed by the consumer group to the registered clients, and regularly check whether the current number of partitions of the client exceeds the predetermined number. If it exceeds, the excess partitions are split to other clients with a smaller number.</p></li><li><p>The Master checks whether the current consumer group needs to be load balanced. If necessary, all partitions of the Topic set subscribed by the consumer group and all consumer IDs of this consumer group are sorted, and then the number of partitions and the number of clients of the consumer group are divided and modulo to obtain the maximum number of partitions subscribed by each client; then partitions are allocated to each client, and the partition information is carried in the heartbeat response when the consumer subscribes; if the client currently has more partitions, a partition release instruction is given to the client to release the partition from the consumer, and a partition allocation instruction is given to the allocated consumer to inform the partition that the corresponding client is allocated. The specific instructions are as follows:</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">message EventProto{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int64 rebalanceId = 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int32 opType = 2;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    optional int32 status = 3;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /* consumerId@group-brokerId:host:port-topic:partitionId */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    repeated string subscribeInfo = 4;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> Among them:</p><ul><li><p>rebalanceId: self-incrementing long value ID, indicating the round of load balancing;</p></li><li><p>subscribeInfo: indicates the assigned partition information;</p></li><li><p>opType: operation code, the value is defined in EventType, and the currently implemented operation codes only have the following 4 parts: release connection, establish connection; only<!-- -->_<!-- -->xxx is not expanded at present. After receiving the load balancing information carried in the heartbeat, the Consumer performs corresponding business operations according to this value;</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">switch (event.getType()) {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       case DISCONNECT:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       case ONLY_DISCONNECT:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           disconnectFromBroker(event);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           rebalanceResults.put(event);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           break;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       case CONNECT:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       case ONLY_CONNECT:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           connect2Broker(event);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           rebalanceResults.put(event);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           break;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       case REPORT:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           reportSubscribeInfo();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           break;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       case STOPREBALANCE:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           break;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       default:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">           throw new TubeClientException(strBuffer</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                   .append(&quot;Invalid rebalance opCode:&quot;)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                   .append(event.getType()).toString());</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>status: indicates the status of the event, defined in <code>EventStatus</code>:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">public enum EventStatus {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * To be processed state.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    TODO(0, &quot;To be processed&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * On processing state.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    PROCESSING(1, &quot;Being processed&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * Processed state.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    DONE(2, &quot;Process Done&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * Unknown state.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    UNKNOWN(-1, &quot;Unknown event status&quot;),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * Failed state.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     * */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    FAILED(-2, &quot;Process failed&quot;);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul></li><li><p>When the Master constructs the load balancing processing task, it sets the instruction status to TODO; when the client heartbeat request comes, the Master writes the task into the response message and sets the instruction status to PROCESSING; the client receives the load balancing instruction from the heartbeat response, performs the actual connection or disconnection operation, and after the operation is completed, sets the instruction status to DONE, and waits for the next heartbeat request to be sent back to the Master;</p></li><li><p>Consumer operation: After the Consumer receives the metadata information returned by the Master, it establishes and releases the connection, see the opType annotation above, and after the connection is established, returns the event processing result to the Master, thereby completing the related operations of receiving tasks, executing tasks, and returning task processing results; it should be noted that load balancing registration is a best-effort operation. If the consumer initiates a connection operation, but the consumer that previously occupied the partition has not had time to exit, it will receive <code>PARTITION_OCCUPIED</code> The partition is deleted from the attempt queue at this time; the previous partition consumer will still perform the deletion operation after receiving the corresponding response, so that the consumer assigned to this partition in the next round of load balancing is successfully registered on the partition.</p></li></ol><p>At this point, the consumption balancing operation on the consumer side is completed, and the consumer registers and consumes data after obtaining the partition information.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/inlong-website/edit/master/versioned_docs/version-2.0.0/development/binary_protocol/tubemq_binary.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/2.0.0/development/binary_protocol/dataproxy_binary"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">DataProxy binary protocol and usage</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/2.0.0/development/binary_protocol/audit_msg"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Audit data format definition and usage</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#tubemq-message-format" class="table-of-contents__link toc-highlight">TubeMQ message format</a><ul><li><a href="#pb-format-encoding" class="table-of-contents__link toc-highlight">PB format encoding</a></li></ul></li><li><a href="#client-request-response-interaction" class="table-of-contents__link toc-highlight">Client request response interaction</a><ul><li><a href="#producer-production-interaction-diagram" class="table-of-contents__link toc-highlight">Producer production interaction diagram</a></li><li><a href="#consumer-consumption-interaction-diagram" class="table-of-contents__link toc-highlight">Consumer consumption interaction diagram</a></li><li><a href="#the-rpc-interaction-process-between-the-client-and-the-server" class="table-of-contents__link toc-highlight">The RPC interaction process between the client and the server</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Events</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.apachecon.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">ApacheCon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="acevent" data-format="square" data-mode="dark" data-event="random"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/ApacheInlong" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://inlong.apache.org/img/apache-inlong-wechat.jpg" target="_blank" rel="noopener noreferrer" class="footer__link-item">WeChat<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="mailto:dev@inlong.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/apache/inlong" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/asf_logo.svg" alt="Apache InLong" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/asf_logo.svg" alt="Apache InLong" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></div><div class="footer__copyright"><div style="font-family: Avenir-Medium;font-size: 14px;color: #999;">
          <div>Copyright © 2020-2024 The Apache Software Foundation. Licensed under the Apache License, Version 2.0.</div>
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #666;line-height: 20px;">The Apache Software Foundation Apache InLong, InLong, Apache, the Apache feather, and the Apache InLong project logo are either registered trademarks or trademarks of the Apache Software Foundation.</div>
        </div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.1307b338.js"></script>
<script src="/assets/js/main.919e10fa.js"></script>
</body>
</html>