{
  "filename": "quick_start.md",
  "__html": "<h2>Prerequisites</h2>\n<ul>\n<li>Java 1.7 or 1.8(Java 9 and above haven't been verified yet)</li>\n<li>Maven</li>\n<li><a href=\"https://github.com/protocolbuffers/protobuf/releases/tag/v2.5.0\">protoc 2.5.0</a></li>\n</ul>\n<h2>Build</h2>\n<h3>Build distribution tarball</h3>\n<p>在TubeMQ根目录下执行命令：</p>\n<pre><code class=\"language-bash\">mvn clean package -DskipTests\n</code></pre>\n<p>在根目录执行 <code>mvn clean install</code> 之后，可以单独对每个 module 进行构建。</p>\n<h3>Build source code</h3>\n<p>在IDE中构建和调试源码，需要先运行以下命令：</p>\n<pre><code class=\"language-bash\">mvn compile\n</code></pre>\n<p>执行之后，会生成 <code>protoc</code> 文件对应的 java source file，位于 <code>target/generated-sources</code> 目录。</p>\n<p>然后就可以在 IDE 中打开 TubeMQ 工程。</p>\n<h2>Deploy</h2>\n<p>构建完成之后，在 <code>tubemq-server/target</code> 目录下会有 <strong>tubemq-server-x.x.x-bin.tar.gz</strong> 文件.\n这是 Server 的部署包，包含了脚本、配置文件、依赖以及 web GUI相关的内容。</p>\n<p>首次部署，只需要解压部署包，解压之后的目录结构如下：</p>\n<pre><code>/opt/tubemq-server\n├── bin\n├── conf\n├── lib\n├── logs\n└── resources\n</code></pre>\n<h3>Configure</h3>\n<p>TubeMQ 集群有两个角色: <strong>Master</strong> 和 <strong>Broker</strong>. Master 和 Broker 可以部署在相同或者不同的节点上。下面是\n一个集群的配置示例：</p>\n<table>\n<thead>\n<tr>\n<th>Role</th>\n<th>TCP Port</th>\n<th>TLS Port</th>\n<th>Web Port</th>\n<th>Comment</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Master</td>\n<td>8099</td>\n<td>8199</td>\n<td>8080</td>\n<td>元数据存储在 /stage/metadata</td>\n</tr>\n<tr>\n<td>Broker</td>\n<td>8123</td>\n<td>8124</td>\n<td>8081</td>\n<td>消息存储在 /stage/msgdata</td>\n</tr>\n<tr>\n<td>Zookeeper</td>\n<td>2181</td>\n<td></td>\n<td></td>\n<td>Offset 存储在 /tubemq</td>\n</tr>\n</tbody>\n</table>\n<p>详细的配置信息如下所示，注意将 <code>YOUR_SERVER_IP</code> 替换为真实的IP。</p>\n<h4>master.ini</h4>\n<pre><code class=\"language-ini\"><span class=\"hljs-section\">[master]</span>\n<span class=\"hljs-attr\">hostName</span>=YOUR_SERVER_IP\n<span class=\"hljs-attr\">port</span>=<span class=\"hljs-number\">8000</span>\n<span class=\"hljs-attr\">webPort</span>=<span class=\"hljs-number\">8080</span>\n<span class=\"hljs-attr\">consumerBalancePeriodMs</span>=<span class=\"hljs-number\">30000</span>\n<span class=\"hljs-attr\">firstBalanceDelayAfterStartMs</span>=<span class=\"hljs-number\">60000</span>\n<span class=\"hljs-attr\">consumerHeartbeatTimeoutMs</span>=<span class=\"hljs-number\">30000</span>\n<span class=\"hljs-attr\">producerHeartbeatTimeoutMs</span>=<span class=\"hljs-number\">45000</span>\n<span class=\"hljs-attr\">brokerHeartbeatTimeoutMs</span>=<span class=\"hljs-number\">25000</span>\n<span class=\"hljs-attr\">confModAuthToken</span>=abc\n<span class=\"hljs-attr\">webResourcePath</span>=/opt/tubemq-server/resources\n\n<span class=\"hljs-section\">[zookeeper]</span>\n<span class=\"hljs-attr\">zkNodeRoot</span>=/tubemq\n<span class=\"hljs-attr\">zkServerAddr</span>=localhost:<span class=\"hljs-number\">2181</span>\n<span class=\"hljs-attr\">zkSessionTimeoutMs</span>=<span class=\"hljs-number\">30000</span>\n<span class=\"hljs-attr\">zkConnectionTimeoutMs</span>=<span class=\"hljs-number\">30000</span>\n<span class=\"hljs-attr\">zkSyncTimeMs</span>=<span class=\"hljs-number\">5000</span>\n<span class=\"hljs-attr\">zkCommitPeriodMs</span>=<span class=\"hljs-number\">5000</span>\n\n<span class=\"hljs-section\">[bdbStore]</span>\n<span class=\"hljs-attr\">bdbRepGroupName</span>=tubemqMasterGroup\n<span class=\"hljs-attr\">bdbNodeName</span>=tubemqMasterGroupNode1\n<span class=\"hljs-attr\">bdbNodePort</span>=<span class=\"hljs-number\">9001</span>\n<span class=\"hljs-attr\">bdbEnvHome</span>=/stage/metadata\n<span class=\"hljs-attr\">bdbHelperHost</span>=<span class=\"hljs-number\">9.134</span>.<span class=\"hljs-number\">8.170</span>:<span class=\"hljs-number\">9001</span>\n<span class=\"hljs-attr\">bdbLocalSync</span>= <span class=\"hljs-number\">1</span>\n<span class=\"hljs-attr\">bdbReplicaSync</span>= <span class=\"hljs-number\">3</span>\n<span class=\"hljs-attr\">bdbReplicaAck</span>= <span class=\"hljs-number\">1</span>\n<span class=\"hljs-attr\">bdbStatusCheckTimeoutMs</span>=<span class=\"hljs-number\">10000</span>\n</code></pre>\n<h5>resources/velocity.properties</h5>\n<pre><code class=\"language-properties\"><span class=\"hljs-meta\">resource.loader</span>=<span class=\"hljs-string\">file</span>\n<span class=\"hljs-meta\">file.resource.loader.description</span>=<span class=\"hljs-string\">Velocity File Resource Loader</span>\n<span class=\"hljs-meta\">file.resource.loader.class</span>=<span class=\"hljs-string\">org.apache.velocity.runtime.resource.loader.FileResourceLoader</span>\n<span class=\"hljs-meta\">file.resource.loader.path</span>=<span class=\"hljs-string\">/opt/tubemq-server/resources/templates</span>\n<span class=\"hljs-meta\">file.resource.loader.cache</span>=<span class=\"hljs-string\">false</span>\n<span class=\"hljs-meta\">file.resource.loader.modificationCheckInterval</span>=<span class=\"hljs-string\">2</span>\n<span class=\"hljs-meta\">string.resource.loader.description</span>=<span class=\"hljs-string\">Velocity String Resource Loader</span>\n<span class=\"hljs-meta\">string.resource.loader.class</span>=<span class=\"hljs-string\">org.apache.velocity.runtime.resource.loader.StringResourceLoader</span>\n<span class=\"hljs-meta\">input.encoding</span>=<span class=\"hljs-string\">UTF-8</span>\n<span class=\"hljs-meta\">output.encoding</span>=<span class=\"hljs-string\">UTF-8</span>\n</code></pre>\n<h5>conf/broker.ini</h5>\n<pre><code class=\"language-ini\"><span class=\"hljs-section\">[broker]</span>\n<span class=\"hljs-attr\">brokerId</span>=<span class=\"hljs-number\">0</span>\n<span class=\"hljs-attr\">hostName</span>=YOUR_SERVER_IP\n<span class=\"hljs-attr\">port</span>=<span class=\"hljs-number\">8123</span>\n<span class=\"hljs-attr\">webPort</span>=<span class=\"hljs-number\">8081</span>\n<span class=\"hljs-attr\">masterAddressList</span>=YOUR_SERVER_IP:<span class=\"hljs-number\">8000</span>\n<span class=\"hljs-attr\">primaryPath</span>=/stage/msgdata\n<span class=\"hljs-attr\">maxSegmentSize</span>=<span class=\"hljs-number\">1073741824</span>\n<span class=\"hljs-attr\">maxIndexSegmentSize</span>=<span class=\"hljs-number\">22020096</span>\n<span class=\"hljs-attr\">transferSize</span>= <span class=\"hljs-number\">524288</span>\n<span class=\"hljs-attr\">loadMessageStoresInParallel</span>=<span class=\"hljs-literal\">true</span>\n<span class=\"hljs-attr\">consumerRegTimeoutMs</span>=<span class=\"hljs-number\">35000</span>\n\n<span class=\"hljs-section\">[zookeeper]</span>\n<span class=\"hljs-attr\">zkNodeRoot</span>=/tubemq\n<span class=\"hljs-attr\">zkServerAddr</span>=localhost:<span class=\"hljs-number\">2181</span>\n<span class=\"hljs-attr\">zkSessionTimeoutMs</span>=<span class=\"hljs-number\">30000</span>\n<span class=\"hljs-attr\">zkConnectionTimeoutMs</span>=<span class=\"hljs-number\">30000</span>\n<span class=\"hljs-attr\">zkSyncTimeMs</span>=<span class=\"hljs-number\">5000</span>\n<span class=\"hljs-attr\">zkCommitPeriodMs</span>=<span class=\"hljs-number\">5000</span>\n<span class=\"hljs-attr\">zkCommitFailRetries</span>=<span class=\"hljs-number\">10</span>\n\n</code></pre>\n<p>特别的，对于 Master 节点，需要在 <code>/etc/hosts</code> 中配置其他 Master 节点的信息，如果有三个 Master 节点：</p>\n<pre><code>192.168.1.2 hostname-2\n192.168.1.3 hostname-3\n192.168.1.4 hostname-4\n</code></pre>\n<h2>Start Cluster</h2>\n<p>配置完成之后，就可以按照以下步骤启动集群。</p>\n<h3>Start Master</h3>\n<p>完成如上配置设置后，首先进入主备Master所在的TubeMQ环境的 <code>bin</code> 目录，进行服务启动操作。</p>\n<pre><code class=\"language-bash\">./master.sh start\n</code></pre>\n<p>访问Master的管控台 <code>http://your-master-ip:8080/config/topic_list.htm</code> ，页面可查则表示 master 已成功启动。</p>\n<p><img src=\"img/tubemq-console-gui.png\" alt=\"TubeMQ Console GUI\"></p>\n<h2>Start Broker</h2>\n<p>Broker启动前，首先要在Master上配置Broker元数据，增加Broker相关的管理信息。</p>\n<p>在<code>Broker List</code> 页面,  <code>Add Single Broker</code>，然后填写相关信息。</p>\n<p><img src=\"img/tubemq-add-broker-1.png\" alt=\"Add Broker 1\"></p>\n<p>需要填写的内容包括：</p>\n<ol>\n<li>broker IP: broker server ip</li>\n<li>authToken:  <code>conf/master.ini</code> 文件中 <code>confModAuthToken</code> 字段配置的 token</li>\n</ol>\n<p>然后上线Broker：</p>\n<p><img src=\"img/tubemq-add-broker-2.png\" alt=\"Add Broker 2\"></p>\n<p>到 Broker 节点的 <code>bin</code> 目录下，执行以下命令启动 Broker服务：</p>\n<pre><code class=\"language-bash\">./broker.sh start\n</code></pre>\n<p>刷新页面可以看到 Broker 已经注册，当 <code>当前运行子状态</code> 为 <code>idle</code> 时， 可以增加topic。</p>\n<p><img src=\"img/tubemq-add-broker-3.png\" alt=\"Add Broker 3\"></p>\n<h2>Add Topic</h2>\n<p>可以通过 web GUI 添加 Topic， 在 <code>Topic列表</code>页面添加，需要填写相关信息</p>\n<p><img src=\"img/tubemq-add-topic-1.png\" alt=\"Add Topic 1\"></p>\n<p>然后选择部署 Topic 的 Broker</p>\n<p><img src=\"img/tubemq-add-topic-5.png\" alt=\"Add Topic 5\"></p>\n<p>此时 Broker的 <code>可发布</code> 和 <code>可订阅</code> 依旧是灰色的</p>\n<p><img src=\"img/tubemq-add-topic-6.png\" alt=\"Add Topic 6\"></p>\n<p>需要在 <code>Broker列表</code>页面重载Broker 配置</p>\n<p><img src=\"img/tubemq-add-topic-2.png\" alt=\"Add Topic 2\"></p>\n<p><img src=\"img/tubemq-add-topic-3.png\" alt=\"Add Topic 3\"></p>\n<p>之后就可以在页面查看Topic信息。</p>\n<p><img src=\"img/tubemq-add-topic-4.png\" alt=\"Add Topic 4\"></p>\n<h2>Demo</h2>\n<p>可以使用 Example 来测试集群。首先，我们运行 producer的demo，注意将 <code>YOUR_SERVER_IP</code> 替换为实际的IP.</p>\n<pre><code class=\"language-bash\">java -Dlog4j.configuration=file:/opt/tubemq-server/conf/tools.log4j.properties  -Djava.net.preferIPv4Stack=<span class=\"hljs-literal\">true</span> -cp  /opt/tubemq-server/lib/*:/opt/tubemq-server/conf/*: com.tencent.tubemq.example.MessageProducerExample YOUR_SERVER_IP YOUR_SERVER_IP:8000 demo 10000000\n</code></pre>\n<p>从日志我们可以看到，数据发送成功</p>\n<pre><code class=\"language-bash\">[2019-09-11 16:09:08,287] INFO Send demo 1000 message, keyCount is 268 (com.tencent.tubemq.example.MessageProducerExample)\n[2019-09-11 16:09:08,505] INFO Send demo 2000 message, keyCount is 501 (com.tencent.tubemq.example.MessageProducerExample)\n[2019-09-11 16:09:08,958] INFO Send demo 3000 message, keyCount is 755 (com.tencent.tubemq.example.MessageProducerExample)\n[2019-09-11 16:09:09,085] INFO Send demo 4000 message, keyCount is 1001 (com.tencent.tubemq.example.MessageProducerExample)\n</code></pre>\n<p>然后运行 consume 的 demo，<code>YOUR_SERVER_IP</code> 也需要替换</p>\n<pre><code class=\"language-bash\">java -Xmx512m -Dlog4j.configuration=file:/opt/tubemq-server/conf/tools.log4j.properties -Djava.net.preferIPv4Stack=<span class=\"hljs-literal\">true</span> -cp /opt/tubemq-server/lib/*:/opt/tubemq-server/conf/*: com.tencent.tubemq.example.MessageConsumerExample YOUR_SERVER_IP YOUR_SERVER_IP:8000 demo demoGroup 3 1 1\n</code></pre>\n<p>从日志我们可以看到，数据被消费者消费到</p>\n<pre><code class=\"language-bash\">[2019-09-11 16:09:29,720] INFO Receive messages:2500 (com.tencent.tubemq.example.MsgRecvStats)\n[2019-09-11 16:09:30,059] INFO Receive messages:5000 (com.tencent.tubemq.example.MsgRecvStats)\n[2019-09-11 16:09:34,493] INFO Receive messages:10000 (com.tencent.tubemq.example.MsgRecvStats)\n[2019-09-11 16:09:34,783] INFO Receive messages:12500 (com.tencent.tubemq.example.MsgRecvStats)\n</code></pre>\n<hr>\n",
  "link": "/zh-cn/docs/quick_start.html",
  "meta": {}
}